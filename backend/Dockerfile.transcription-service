# Base image
FROM debian:latest AS build

# Upadte and install g++, make and wget
RUN apt-get update \
    && apt-get install -y g++ make wget

# Download and extract the files
RUN mkdir /whisper && \
    wget -q https://github.com/ggerganov/whisper.cpp/tarball/master -O - | \
    tar -xz -C /whisper --strip-components 1

# Set the workdir to /whisper
WORKDIR /whisper

# Download the quantized small.en model
RUN bash ./models/download-ggml-model.sh small.en-q5_1

# Build the main file
RUN make main


# Production image
FROM debian:latest AS production

# Update and ckean
RUN apt-get update \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set the workdirectory
WORKDIR /root

# make the models directory
RUN mkdir /root/models

# copy the required files from the build image
COPY --from=build "/whisper/models/ggml-small.en-q5_1.bin" "/root/models/ggml-small.en-q5_1.bin"
COPY --from=build /whisper/main /usr/local/bin/whisper

# Set the entrypoint
CMD ["bash"]

# whisper -t 2 -m /root/models/ggml-small.en-q5_1.bin -f /data/202309-1208-3532-462488bf-c3b1-4226-84fa-711b8558a600/file.wav -osrt -of /data/transcriptions
# whisper -t 2 -m /root/models/ggml-small.en-q5_1.bin -f /data/202309-1417-5012-1bd7022d-c263-4bbb-89a4-9348abdb52ef/file.wav -osrt -of /data/transcriptions